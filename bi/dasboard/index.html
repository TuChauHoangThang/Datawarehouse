<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Data Warehouse Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg: #f4f6fb;
            --card-bg: #ffffff;
            --primary: #1e88e5;
            --secondary: #26a69a;
            --accent: #ff7043;
            --text: #1f2a37;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }
        header {
            padding: 24px 32px;
            background: #0f172a;
            color: #fff;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 12px;
        }
        header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        header .meta {
            font-size: 14px;
            opacity: 0.85;
        }
        main {
            padding: 32px;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        .card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(15,23,42,0.06);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .card span {
            font-size: 14px;
            color: #64748b;
        }
        .card strong {
            font-size: 26px;
            color: var(--text);
        }
        section {
            background: var(--card-bg);
            border-radius: 14px;
            box-shadow: 0 10px 25px rgba(15,23,42,0.06);
            padding: 20px;
        }
        section h2 {
            margin-top: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        canvas {
            width: 100% !important;
            height: 320px !important;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #e2e8f0;
            text-align: left;
        }
        th { background: #f8fafc; }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #475569;
        }
        .pill {
            display: inline-flex;
            padding: 2px 10px;
            border-radius: 999px;
            background: #e0f2fe;
            color: #0369a1;
            font-size: 12px;
            font-weight: 600;
        }
        .error {
            color: #d32f2f;
            padding: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>Data Warehouse Dashboard</h1>
        <div class="meta">
            Cập nhật thời gian thực từ `fact_stream_snapshot` – kết hợp Twitch & YouTube
        </div>
        <div class="meta" id="last-update"></div>
    </header>
    <main>
        <div class="cards" id="summary-cards">
            <!-- dynamic cards -->
        </div>

        <div class="grid">
            <section>
                <h2>Phân bổ nền tảng (24h gần nhất)</h2>
                <canvas id="platformChart"></canvas>
            </section>
            <section>
                <h2>Top 10 trò chơi</h2>
                <canvas id="topGameChart"></canvas>
            </section>
        </div>

        <div class="grid">
            <section>
                <h2>Xu hướng người xem theo giờ</h2>
                <canvas id="viewerTrendChart"></canvas>
            </section>
            <section>
                <h2>Top streamer gần đây</h2>
                <div class="table-wrapper">
                    <table id="streamerTable">
                        <thead>
                            <tr>
                                <th>Streamer</th>
                                <th>Nền tảng</th>
                                <th>Lượt xem</th>
                                <th>Số stream</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
    </div>

        <section>
            <h2>Top trò chơi theo từng ngày (14 ngày gần nhất)</h2>
            <canvas id="dailyGameChart"></canvas>
        </section>

        <section>
            <h2>Trạng thái ETL mới nhất</h2>
            <div class="grid">
                <div>
                    <h3>Batch gần đây</h3>
                    <table id="batchTable">
                        <thead>
                            <tr>
                                <th>Batch</th>
                                <th>Ngày</th>
                                <th>Trạng thái</th>
                                <th>Files</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h3>Job gần đây</h3>
                    <table id="jobTable">
                        <thead>
                            <tr>
                                <th>Job</th>
                                <th>Start</th>
                                <th>Status</th>
                                <th>Records</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div>
                    <h3>File audit</h3>
                    <table id="fileTable">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Records</th>
                                <th>Status</th>
                                <th>Batch</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
    <script>
        const formatter = new Intl.NumberFormat("vi-VN");

        async function fetchJSON(url) {
            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`${url} -> ${res.status}`);
                return await res.json();
            } catch (err) {
                console.error("Fetch error:", err);
                return null;
            }
        }

        function setCards(data) {
            const container = document.getElementById("summary-cards");
            if (!data) {
                container.innerHTML = '<div class="card error">Không lấy được dữ liệu summary</div>';
                return;
            }
            container.innerHTML = `
                <div class="card">
                    <span>Tổng người xem (24h)</span>
                    <strong>${formatter.format(data.total_viewers)}</strong>
                </div>
                <div class="card">
                    <span>Số stream (24h)</span>
                    <strong>${formatter.format(data.total_streams)}</strong>
                </div>
                <div class="card">
                    <span>Số trò chơi</span>
                    <strong>${formatter.format(data.total_games)}</strong>
                </div>
                <div class="card">
                    <span>Số streamer</span>
                    <strong>${formatter.format(data.total_streamers)}</strong>
                </div>`;
        }

        function renderChart(canvasId, config) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            return new Chart(ctx, config);
        }

        function formatDate(value) {
            if (!value) return "-";
            return new Date(value).toLocaleString("vi-VN");
        }

        async function initDashboard() {
            const summary = await fetchJSON("/api/summary_cards");
            setCards(summary);

            const platformData = await fetchJSON("/api/platform_breakdown");
            if (platformData) {
                renderChart("platformChart", {
                    type: "doughnut",
                    data: {
                        labels: platformData.map(d => d.platform_name),
                        datasets: [{
                            data: platformData.map(d => d.viewers),
                            backgroundColor: ["#1e88e5","#26a69a","#ff7043","#ab47bc","#ffa726"]
                        }]
                    },
                    options: {
                        plugins: { legend: { position: "bottom" } }
                    }
                });
            }

            const topGames = await fetchJSON("/api/top_games");
            if (topGames) {
                renderChart("topGameChart", {
                    type: "bar",
                    data: {
                        labels: topGames.map(d => d.game),
                        datasets: [{
                            label: "Lượt xem",
                            data: topGames.map(d => d.viewers),
                            backgroundColor: "rgba(30,136,229,0.6)"
                        }]
                    },
                    options: {
                        indexAxis: "y",
                        responsive: true,
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }

            const viewerTrends = await fetchJSON("/api/viewer_trends");
            if (viewerTrends) {
                renderChart("viewerTrendChart", {
                    type: "line",
                data: {
                        labels: viewerTrends.map(d => formatDate(d.time)),
                    datasets: [{
                            label: "Tổng người xem",
                            data: viewerTrends.map(d => d.viewers),
                            fill: true,
                            borderColor: "#26a69a",
                            backgroundColor: "rgba(38,166,154,0.2)",
                            tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            const topStreamers = await fetchJSON("/api/top_streamers_recent");
            const tableBody = document.querySelector("#streamerTable tbody");
            if (topStreamers && tableBody) {
                tableBody.innerHTML = topStreamers.map(item => `
                    <tr>
                        <td>${item.streamer}</td>
                        <td><span class="pill">${item.platform}</span></td>
                        <td>${formatter.format(item.viewers)}</td>
                        <td>${formatter.format(item.streams)}</td>
                    </tr>
                `).join("");
            }

            const dailyGames = await fetchJSON("/api/top_games_daily");
            if (dailyGames) {
                const grouped = {};
                dailyGames.forEach(row => {
                    if (!grouped[row.game]) grouped[row.game] = [];
                    grouped[row.game].push({ day: row.day, viewers: row.viewers });
                });
                const sortedDays = [...new Set(dailyGames.map(d => d.day))].sort();
                renderChart("dailyGameChart", {
                    type: "line",
                    data: {
                        labels: sortedDays.map(d => formatDate(d)),
                        datasets: Object.entries(grouped).slice(0,5).map(([game, records], idx) => ({
                            label: game,
                            data: sortedDays.map(day => {
                                const found = records.find(r => r.day === day);
                                return found ? found.viewers : 0;
                            }),
                            borderWidth: 2,
                            tension: 0.35,
                            fill: false,
                            borderColor: ["#1e88e5","#ff7043","#26a69a","#ab47bc","#ffa726"][idx % 5]
                        }))
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            const lastUpdate = await fetchJSON("/api/last_update");
            if (lastUpdate) {
                document.getElementById("last-update").textContent =
                    `Last ETL: ${formatDate(lastUpdate.last_capture_time)} (server: ${formatDate(lastUpdate.server_time)})`;
            }

            const batches = await fetchJSON("/api/etl/batches");
            if (batches && batches.batches) {
                const tbody = document.querySelector("#batchTable tbody");
                tbody.innerHTML = batches.batches.slice(0, 10).map(b => `
                    <tr>
                        <td>#${b.batch_id}</td>
                        <td>${formatDate(b.batch_start_time)}</td>
                        <td>${b.status}</td>
                        <td>${b.files_processed ?? 0}</td>
                    </tr>
                `).join("");
            }

            const jobs = await fetchJSON("/api/etl/jobs");
            if (jobs && jobs.jobs) {
                const tbody = document.querySelector("#jobTable tbody");
                tbody.innerHTML = jobs.jobs.slice(0, 10).map(j => `
                    <tr>
                        <td>${j.job_name}</td>
                        <td>${formatDate(j.start_time)}</td>
                        <td>${j.status}</td>
                        <td>${formatter.format(j.records_processed ?? 0)}</td>
                    </tr>
                `).join("");
            }

            const files = await fetchJSON("/api/etl/files");
            if (files && files.files) {
                const tbody = document.querySelector("#fileTable tbody");
                tbody.innerHTML = files.files.slice(0, 10).map(f => `
                    <tr>
                        <td>${f.file_name}</td>
                        <td>${formatter.format(f.records_count ?? 0)}</td>
                        <td>${f.status}</td>
                        <td>${f.batch_id ?? "-"}</td>
                    </tr>
                `).join("");
            }
        }

        initDashboard();
    </script>
</body>
</html>
